<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML+RDFa 1.0//EN" "http://www.w3.org/MarkUp/DTD/xhtml-rdfa-1.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:foaf="http://xmlns.com/foaf/0.1/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:svg="http://www.w3.org/2000/svg" version="XHTML+RDFa 1.0" xml:lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>View</title>
    <link rel="stylesheet" href="css/backside.css" type="text/css" media="screen" charset="utf-8"/>
    <script type="text/javascript" charset="utf-8">
    // <![CDATA[
    window.bootstrap = (function() {
      var components = [], scripts = [];
      return { 
        add: function(fun) {components.unshift(fun);},
        tag: function (src) {var s = document.createElement('script'); s.type = 'text/javascript'; s.src = src;return s;},
        queue: function(){for (var i=0; i < arguments.length; i++) {var s = this.tag(arguments[i]); s.onload = this.load; scripts.push(s);}; return this;},
        load: function(){ if (scripts.length > 0) {document.body.appendChild(scripts.shift()); } else { window.bootstrap.init(); } },
        init: function() {components.forEach(function(component) { if (typeof component != 'function') return; component.call(); }); }
    };})();
    bootstrap.queue('js/mootools-core.js', 'js/mootools-more.js', 'js/admin.js');
    window.onload = window.bootstrap.load;
    // ]]>
  </script>
  
  </head>
  <body>
  <section id="toolbar" class="container">
    <div class="_25 column">
      <select name="episode_selector" id="episode_selector" class="menu">
        <option selected="selected">Select Show</option>
        <option value="episodes/401-08-02-2013.md">Show #401: 08.02.13</option>
        <option value="episodes/400-07-26-2013.md">Show #400: 07.26.13</option>
      </select>
      <button id="save" class="menu">Save</button>
      <div id="test"></div>
    </div>
    <div class="_5 column">
      <p><em id="statistics">Statistics</em></p>
    </div>
    <div class="_25 column">
      <p><time id="timestamp">Preview</time></p>
    </div>
  </section>

  <section class="container">
    <div class="_25 column">
      <div id="tagger"></div>
      <details id="help">
        <summary>Help With Tagging</summary>
        <dl>
          <dt>What are tags for?</dt>
          <dd>Tags are the brain of this operation. In a nutshell, there is copy, some very minimal styling, and heavy tag-age. That said, tags should be significant across episodes and even within an article. For example, 'guitarist' is a good tag because it could be related to another <strong>catagorical tag</strong> such as name[somebody] which will give the query engine lots more to work with.</dd>
          <dt>What is a categorical tag?</dt>
          <dd>categorical tags are prefixed with something other than {tag: whatever}; ie {artist: whatever}, {place: whatever}.</dd>
          <dt>What are the tag rules</dt>
          <dd>Tag <em>keywords</em> should be lowercase, always. They have the format <strong>keyword[</strong>Some Text<strong>]</strong></dd>
        </dl>
      </details>
    </div>
    <div id="notebook" class="_5 column">
      <textarea id="selection" class="editing" spellcheck="false"></textarea>
    </div>
    <iframe class="_25 column" id="preview" src="preview.html" name="preview_frame" seamless="seamless" width="100%"></iframe>
  </section> 
  
  <div id="network" class="container"></div>

  <script type="text/javascript" charset="utf-8">
    //<![CDATA[
    
    bootstrap.add(function () {
      

      var tagger = new Ed.tagger('tagger');
      var editor = new Ed.it('selection');
      
      document.id('episode_selector').addEvent('change', function (evt) {
        new Request({
          url:this.value,
          onSuccess: function (response) {
            editor.cursor.setText(response);
            findMetadata(response);
          }
        }).get({nocache: Date.now()});
        editor.field.focus();
      });
      
      document.id('save').addEvent('click', function (evt) {
        evt.stop();
        new Request({
          url: 'save.php',
          onSuccess: function (response) {
            window.alert(response);
          }
        }).post({
          file: document.id('episode_selector').value,
          text: editor.cursor.getText()
        });
      });
      
      editor.addEvent('textSelect', function (evt) {
        tagger.addTag(this.cursor.getSelectedText(), [this.cursor.start, this.cursor.end]);
      })
      
      editor.addEvent('textInput', function () {
        findMetadata(this.cursor.getText());
      });
      
      editor.macro.addEvent('enter', function() {
        console.log('perform enter stuff');
      });
      
      editor.addEvent('cursor', function () {
        var pos = this.cursor.getPosition();
        if (taglist.index[pos] > 0) {
          var elem = taglist.index[pos];
          tagger.edit(taglist.tags[elem]);
        }
      });
      editor.addEvent('ready', function () {
        var size = window.getComputedStyle(this.field, null).getPropertyValue("line-height");
        var bg = btoa("<svg xmlns='http://www.w3.org/2000/svg' width='"+size+"' height='"+size+"' viewBox='0 0 50 50'><line x1='0' y1='50' x2='50' y2='50' stroke='#9DD1EF' fill='none'/></svg>");
        this.field.style.background = 'transparent url(data:image/svg+xml;base64,'+bg+') repeat 0 1px' ;
        this.field.focus();
        
        // this.field.value = this.field.value.replace(/([0-9]{1,2}\.)\s*(.+?)\,\s*“?(.+?)”?\,”?\s*(.+?)\,\s*(.+?)\,\s*?([0-9]{4})/gi, "$1 {artist: $2}, \"{track: $3}\", {album: $4}, {label: $5}, {era: $6}");
        findMetadata(this.field.value);
        
      });
      
      var wheight = window.getSize().y;
      document.id('preview').setStyle('height',  wheight - 120);
      document.id('notebook').setStyle('height', wheight - 220).addEvent('scroll', function (evt) {
        var percent = this.getScroll().y / 4125;
        var body = document.getElementById('preview').contentDocument.body;
        var bheight = parseInt(window.getComputedStyle(body, null).height);
        window.frames[0].scroll(0, bheight * percent);
      });
    });


    /*

  
  selects_cursor.addEventListener('keyup', function (evt) {
    var startCursor = this.selectionStart;
    switch (evt.keyCode) {
      case 13:
        // enter key, will be tricky
        if (this.selectionStart != this.selectionEnd) {
          var endCursor = this.selectionEnd;
          var selected = this.value.substring(startCursor, endCursor);
          var endIdx  = this.value.length - endCursor;
          var re = new RegExp("([^]{"+startCursor+"})("+selected+")([^]{"+endIdx+"})", 'm');
          this.value = this.value.replace(re, "$1 REPLACE_ME[$2]$3");
        
          this.setSelectionRange(startCursor + 1, endCursor+11 - selected.length);
        }
        break;
    }

  });
  */
  function findMetadata(value) {
    var preview = worker.postMessage(value);
  }
  //]]>
  </script>
  </body>
</html>
