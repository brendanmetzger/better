<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML+RDFa 1.0//EN" "http://www.w3.org/MarkUp/DTD/xhtml-rdfa-1.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:foaf="http://xmlns.com/foaf/0.1/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:svg="http://www.w3.org/2000/svg" version="XHTML+RDFa 1.0" xml:lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>View</title>
    <link rel="stylesheet" href="css/backside.css" type="text/css" media="screen" charset="utf-8"/>
    <script type="text/javascript" charset="utf-8">
    // <![CDATA[
    window.bootstrap = (function() {
      var components = [], scripts = [];
      return { 
        add: function(fun) {components.unshift(fun);},
        tag: function (src) {var s = document.createElement('script'); s.type = 'text/javascript'; s.src = src;return s;},
        queue: function(){for (var i=0; i < arguments.length; i++) {var s = this.tag(arguments[i]); s.onload = this.load; scripts.push(s);}; return this;},
        load: function(){ if (scripts.length > 0) {document.body.appendChild(scripts.shift()); } else { window.bootstrap.init(); } },
        init: function() {components.forEach(function(component) { if (typeof component != 'function') return; component.call(); }); }
    };})();
    bootstrap.queue('js/mootools-core.js', 'js/mootools-more.js', 'js/admin.js');
    window.onload = window.bootstrap.load;
    // ]]>
  </script>
  
  </head>
  <body>
  <section id="toolbar" class="container">
    <div class="_25 column">
      <select name="episode_selector" id="episode_selector" class="menu">
        <option selected="selected">Select Show</option>
        <option value='episodes/401-08-02-2013.md'>Show 401 08-02-2013</option>
        <option value='episodes/400-07-26-2013.md'>Show 400 07-26-2013</option>
        <option value='episodes/379-3-1-2013.md'>Show 379 3-1-2013</option>
        <option value='episodes/378-2-22-2013.md'>Show 378 2-22-2013</option>
        <option value='episodes/377-2-15-2013.md'>Show 377 2-15-2013</option>
        <option value='episodes/376-2-8-2013.md'>Show 376 2-8-2013</option>
        <option value='episodes/375-2-1-2013.md'>Show 375 2-1-2013</option>
        <option value='episodes/374-1-25-2013.md'>Show 374 1-25-2013</option>
        <option value='episodes/373-1-18-2013.md'>Show 373 1-18-2013</option>
        <option value='episodes/372-1-11-2013.md'>Show 372 1-11-2013</option>
        <option value='episodes/371-1-4-2013.md'>Show 371 1-4-2013</option>
        <option value='episodes/370-12-28-2012.md'>Show 370 12-28-2012</option>
        <option value='episodes/369-12-21-2012.md'>Show 369 12-21-2012</option>
        <option value='episodes/368-12-14-2012.md'>Show 368 12-14-2012</option>
        <option value='episodes/367-12-7-2012.md'>Show 367 12-7-2012</option>
        <option value='episodes/366-11-30-2012.md'>Show 366 11-30-2012</option>
        <option value='episodes/365-11-23-2012.md'>Show 365 11-23-2012</option>
        <option value='episodes/364-11-16-2012.md'>Show 364 11-16-2012</option>
        <option value='episodes/363-11-09-2012.md'>Show 363 11-09-2012</option>
        <option value='episodes/362-11-02-2012.md'>Show 362 11-02-2012</option>
        <option value='episodes/361-10-26-2012.md'>Show 361 10-26-2012</option>
        <option value='episodes/360-10-19-2012.md'>Show 360 10-19-2012</option>
        <option value='episodes/359-10-12-2012.md'>Show 359 10-12-2012</option>
        <option value='episodes/358-10-5-2012.md'>Show 358 10-5-2012</option>
        <option value='episodes/357-9-28-2012.md'>Show 357 9-28-2012</option>
        <option value='episodes/356-9-21-2012.md'>Show 356 9-21-2012</option>
        <option value='episodes/355-9-14-2012.md'>Show 355 9-14-2012</option>
        <option value='episodes/354-9-7-2012.md'>Show 354 9-7-2012</option>
        <option value='episodes/353-8-31-2012.md'>Show 353 8-31-2012</option>
        <option value='episodes/352-8-24-2012.md'>Show 352 8-24-2012</option>
        <option value='episodes/351-8-17-2012.md'>Show 351 8-17-2012</option>
      </select>
      <button id="save" class="menu">Save</button>
      <div id="test"></div>
    </div>
    <div class="_5 column">
      <p><em id="statistics">Statistics</em></p>
    </div>
    <div class="_25 column">
      <p><time id="timestamp">Preview</time></p>
    </div>
  </section>

  <section class="container">
    <div class="_25 column">
      <div id="tagger"></div>
      <details id="help">
        <summary>Help With Tagging</summary>
        <dl>
          <dt>What are tags for?</dt>
          <dd>Tags are the brain of this operation. In a nutshell, there is copy, some very minimal styling, and heavy tag-age. That said, tags should be significant across episodes and even within an article. For example, 'guitarist' is a good tag because it could be related to another <strong>catagorical tag</strong> such as name[somebody] which will give the query engine lots more to work with.</dd>
          <dt>What is a categorical tag?</dt>
          <dd>categorical tags are prefixed with something other than {tag: whatever}; ie {artist: whatever}, {place: whatever}.</dd>
          <dt>What are the tag rules</dt>
          <dd>Tag <em>keywords</em> should be lowercase, always. They have the format <strong>keyword[</strong>Some Text<strong>]</strong></dd>
        </dl>
      </details>
    </div>
    <div id="notebook" class="_5 column">
      <textarea id="selection" class="editing" spellcheck="false"></textarea>
    </div>
    <iframe class="_25 column" id="preview" src="preview.html" name="preview_frame" seamless="seamless" width="100%"></iframe>
  </section> 
  
  <div id="network" class="container"></div>

  <script type="text/javascript" charset="utf-8">
    //<![CDATA[
    
    bootstrap.add(function () {
      
      new Request({
        url: 'episodes/fetch.php',
        onSuccess: function (response) {
          console.log('episodes');
        }
      }).get();
      
      var tagger = new Ed.tagger('tagger');
      var editor = new Ed.it('selection');
      
      document.id('episode_selector').addEvent('change', function (evt) {
        new Request({
          url:this.value,
          onSuccess: function (response) {
            editor.cursor.setText(response);
            findMetadata(response);
          }
        }).get({nocache: Date.now()});
        editor.field.focus();
        document.id('notebook').scrollTo(0,0);
      });
      
      document.id('save').addEvent('click', function (evt) {
        evt.stop();
        new Request({
          url: 'save.php',
          onSuccess: function (response) {
            window.alert(response);
          }
        }).post({
          file: document.id('episode_selector').value,
          text: editor.cursor.getText()
        });
      });
      
      editor.addEvent('textSelect', function (evt) {
        tagger.addTag(this.cursor.getSelectedText(), [this.cursor.start, this.cursor.end]);
      })
      
      editor.addEvent('textInput', function () {
        findMetadata(this.cursor.getText());
      });
      
      editor.macro.addEvent('enter', function() {
        console.log('perform enter stuff');
      });
      
      editor.addEvent('cursor', function () {
        var pos = this.cursor.getPosition();
        if (taglist.index[pos] > 0) {
          var elem = taglist.index[pos];
          tagger.edit(taglist.tags[elem]);
        }
      });
      editor.addEvent('ready', function () {
        var size = window.getComputedStyle(this.field, null).getPropertyValue("line-height");
        var bg = btoa("<svg xmlns='http://www.w3.org/2000/svg' width='"+size+"' height='"+size+"' viewBox='0 0 50 50'><line x1='0' y1='50' x2='50' y2='50' stroke='#9DD1EF' fill='none'/></svg>");
        this.field.style.background = 'transparent url(data:image/svg+xml;base64,'+bg+') repeat 0 1px' ;
        this.field.focus();
        
        // this.field.value = this.field.value.replace(/([0-9]{1,2}\.)\s*(.+?)\,\s*“?(.+?)”?\,”?\s*(.+?)\,\s*(.+?)\,\s*?([0-9]{4})/gi, "$1 {artist: $2}, \"{track: $3}\", {album: $4}, {label: $5}, {era: $6}");
        findMetadata(this.field.value);
        
      });
      
      var wheight = window.getSize().y;
      document.id('preview').setStyle('height',  wheight - 120);
      document.id('notebook').setStyle('height', wheight - 220).addEvent('scroll', function (evt) {
        var percent = this.getScroll().y / 4125;
        var body = document.getElementById('preview').contentDocument.body;
        var bheight = parseInt(window.getComputedStyle(body, null).height);
        window.frames[0].scroll(0, bheight * percent);
      });
    });

    function findMetadata(value) {
      var preview = worker.postMessage(value);
    }
  //]]>
  </script>
  </body>
</html>
